###########################################################
# Dockerfile that builds a Counter-Strike 1.6 Gameserver
###########################################################
FROM cm2network/steamcmd:root as build_stage

LABEL maintainer="https://github.com/wopox1337"

# Install, update & upgrade packages
RUN set -x \
	&& apt-get update \
	&& apt-get install -y --no-install-recommends --no-install-suggests \
		ca-certificates=20210119 \
		lib32z1=1:1.2.11.dfsg-2+deb11u2 \
        libarchive-tools=3.4.3-2+deb11u1 \
	&& rm -rf /var/lib/apt/lists/*

ENV STEAMAPPID  90
ENV STEAMAPP    hlds
ENV STEAMAPPDIR "${HOMEDIR}/${STEAMAPP}-dedicated"

WORKDIR ${HOMEDIR}

COPY --chmod=755 \
	etc/InstallAddons.sh \
	etc/InstallApp.sh \
	${HOMEDIR}

# Switch to user
USER ${USER}

ARG REHLDS=latest
ARG REGAMEDLL=latest
ARG METAMOD=latest
ARG AMXMODX=latest

RUN ./InstallApp.sh \
	&& ./InstallAddons.sh \
	${REHLDS} \
	${REGAMEDLL} \
	${METAMOD} \
	${AMXMODX} \
	&& mv \
	${STEAMCMDDIR}/steamservice.so \
	${STEAMCMDDIR}/linux32/steamclient.so \
	~/.steam/sdk32/

# Cleanup
RUN rm -rf \
	InstallApp.sh InstallAddons.sh \
	Steam steamcmd .steam/sdk64; \
	&& find $(pwd) \
	\( \
		-name '*64.so' -o \
		-name '*64' -o \
		-name '*.dll' -o \
		-name '*.dylib' \
	\) -exec rm -rf {} \;

# Clean debian-slim server
FROM debian:bookworm-slim

RUN apt-get update \
	&& apt-get install -y --no-install-recommends --no-install-suggests \
		ca-certificates \
		libc6-i386 \
		gdb-minimal \
		nginx \
	&& rm -rf /var/lib/apt/lists/*

# Set environment variables
ARG PUID=1000
ENV USER steam
ENV HOMEDIR "/home/${USER}"

ENV STEAMAPP    hlds
ENV STEAMAPPDIR "${HOMEDIR}/${STEAMAPP}-dedicated"

# Set working directory
WORKDIR $HOMEDIR

# Create unprivileged user
RUN useradd -u "${PUID}" -m "${USER}"

COPY --from=build_stage /home/steam ${HOMEDIR}

WORKDIR ${STEAMAPPDIR}
USER ${USER}

EXPOSE 27016/udp
EXPOSE 80

ENTRYPOINT ["./hlds_run"]
CMD [ "-game cstrike -debug +ip 0.0.0.0 -port 27016 -maxplayers 10 +map de_dust2" ]